/*

TODO:
u noclehu udelej clenitejsi pozadi
u bourky zkrat prodlevu mezi bleskem a hromem
a kdyz je dialog, nejak bile to bliklo, je to zámìr?

kdyz kliknu rukou na okenko na pude a je tam zebrik tak by tam mel vylezt
na certa kliknout ikonou mluveni musi fungovat i na celou mistnost
"perfect click" bude fungovat jen na vyhaneni certa (bude se mi pocitat skore)

*/



// Automatically converted interaction variables
int IntVar_Global_1 = 0;
export IntVar_Global_1;
// main global script file

//int day=0; // current day       //0
//int hour=20; // current hour    //10
//int minute=0; // current minute //0
int loop=0;   // current loop   //0

// the next intervals affect the time duration:
//int minute_time = 40; // [in game loops]
//int hour_time   = 60; // [in minutes]
//int day_time    = 24; // [in hours]

int minute_time = 60; // [in game loops] 3  20     60
int hour_time   = 60; // [in minutes]   35  60     60
int day_time    = 24; // [in hours]         24     24

int turn;
int first=1;
int restarted = false;
int TintTransp=0;
int lastDialogId = 0;
bool lastIconBarVis = true;
String GameVersion;
CursorMode lastCursorMode = eModePointer;


bool isHandheld = false;
bool directInput = false;

bool IsHandheld() {
  return isHandheld;
}

bool JeNoc() {
  return (hour>18) || (hour < 7);
}

function ShowIconBar(bool show) {
  gIconbar.Visible = show;
  lastIconBarVis = show;
}
String tr(String original)
{
  if (IsTranslationAvailable()) {
    return original;
  }
  
  int i = 0;
  while (i<original.Length)
  {
    if (original.Chars[i] == -20) original = original.ReplaceCharAt(i, 1);
    if (original.Chars[i] == -102) original = original.ReplaceCharAt(i, 2);
    if (original.Chars[i] == -24) original = original.ReplaceCharAt(i, 3);
    if (original.Chars[i] == -8) original = original.ReplaceCharAt(i, 4);
    if (original.Chars[i] == -98) original = original.ReplaceCharAt(i, 5);
    if (original.Chars[i] == -3) original = original.ReplaceCharAt(i, 6);
    if (original.Chars[i] == -31) original = original.ReplaceCharAt(i, 7);
    if (original.Chars[i] == -19) original = original.ReplaceCharAt(i, 8);
    if (original.Chars[i] == -23) original = original.ReplaceCharAt(i, 9);
    if (original.Chars[i] == -13) original = original.ReplaceCharAt(i, 10);
    if (original.Chars[i] == -6) original = original.ReplaceCharAt(i, 11);
    if (original.Chars[i] == -7) original = original.ReplaceCharAt(i, 12);
    if (original.Chars[i] == -52) original = original.ReplaceCharAt(i, 13);
    if (original.Chars[i] == -118) original = original.ReplaceCharAt(i, 14);
    if (original.Chars[i] == -56) original = original.ReplaceCharAt(i, 15);
    if (original.Chars[i] == -40) original = original.ReplaceCharAt(i, 16);
    if (original.Chars[i] == -114) original = original.ReplaceCharAt(i, 17);
    if (original.Chars[i] == -35) original = original.ReplaceCharAt(i, 18);
    if (original.Chars[i] == -63) original = original.ReplaceCharAt(i, 19);
    if (original.Chars[i] == -51) original = original.ReplaceCharAt(i, 20);
    if (original.Chars[i] == -55) original = original.ReplaceCharAt(i, 21);
    if (original.Chars[i] == -45) original = original.ReplaceCharAt(i, 22);
    if (original.Chars[i] == -38) original = original.ReplaceCharAt(i, 23);
    if (original.Chars[i] == -39) original = original.ReplaceCharAt(i, 24);
    if (original.Chars[i] == -17) original = original.ReplaceCharAt(i, 25);
    if (original.Chars[i] == -99) original = original.ReplaceCharAt(i, 26);
    if (original.Chars[i] == -14) original = original.ReplaceCharAt(i, 27);
    if (original.Chars[i] == -49) original = original.ReplaceCharAt(i, 28);
    if (original.Chars[i] == -115) original = original.ReplaceCharAt(i, 29);
    if (original.Chars[i] == -46) original = original.ReplaceCharAt(i, 30);
    //Display( "%c %d",original.Chars[i], original.Chars[i]);
    i++;
  }
  original = original.Replace("/10",String.Format("%c",10));
  original = original.Replace("/11",String.Format("%c",11));
  original = original.Replace("/12",String.Format("%c",12));
  original = original.Replace("/13",String.Format("%c",13));
  original = original.Replace("/14",String.Format("%c",14));
  original = original.Replace("/15",String.Format("%c",15));
  original = original.Replace("/16",String.Format("%c",16));
  original = original.Replace("/17",String.Format("%c",17));
  original = original.Replace("/18",String.Format("%c",18));
  original = original.Replace("/19",String.Format("%c",19));
  original = original.Replace("/20",String.Format("%c",20));
  original = original.Replace("/21",String.Format("%c",21));
  original = original.Replace("/22",String.Format("%c",22));
  original = original.Replace("/23",String.Format("%c",23));
  original = original.Replace("/24",String.Format("%c",24));  
  original = original.Replace("/1",String.Format("%c",1));
  original = original.Replace("/2",String.Format("%c",2));
  original = original.Replace("/3",String.Format("%c",3));
  original = original.Replace("/4",String.Format("%c",4));
  original = original.Replace("/5",String.Format("%c",5));
  original = original.Replace("/6",String.Format("%c",6));
  original = original.Replace("/7",String.Format("%c",7));
  original = original.Replace("/8",String.Format("%c",8));
  original = original.Replace("/9",String.Format("%c",9)); 
  return original;
}

function Displayc(String message)
{
  Display(tr(message));
}

function DisplayBottom(int y, String message)
{
  int y2 = system.ViewportHeight-14-14-((message.Length / 37)*10);
  if ((y!=-1) && (y < y2)) y2 = y;
  DisplayAtY(y2, message);
}

String nicTamNeni()
{
  int r = Random(3);
  if (r == 0)
    return tr("Nic tam není.");
   else 
  if (r == 1)
    return tr("Tohle sebrat nejde.");
   else 
  if (r == 2)
    return tr("K èemu ti to bude?");
   else 
    return tr("S tim nemùžeš nic dìlat.");
}

String nicNemluvi()
{
  int r = Random(2);
  if (r == 0)
    return tr("Mlèí to jako ryba.");
   else 
  if (r == 1)
    return tr("S tím si moc nepokecáš.");
   else 
    return tr("Nevím, s èím si tady chceš povídat.");
}

String nicNejdePouzit()
{
  int r = Random(2);
  if (r == 0)
    return tr("Tak to nejde dohromady.");
   else 
  if (r == 1)
    return tr("Nech si to radši u sebe.");
   else 
    return tr("Sem to rozhodnì nepatøí.");
}

String nicNejdeVzit()
{
  int r = Random(2);
  if (r == 0)
    return tr("Nech to na svém místì.");
   else 
  if (r == 1)
    return tr("S tím nejde nic dìlat.");
   else 
    return tr("S tím nic nenadìláš.");
}


void LoadDialogScreen(GUI *dialogScreen, String titleText)
{
  gIconbar.Visible = false;
  gStatusline.Visible = false;
  gCernePozadi.Visible = true;
  Wait(20);
  Displayc(titleText);
  
  dialogScreen.Transparency = 100;
  Wait(1);
  dialogScreen.Visible = true;
  int d = 100;
  while (d>0) 
    { 
      dialogScreen.Transparency = d;
      Wait(1);
      d--;
    }
}

void CloseDialogScreen(GUI *dialogScreen, String titleText)
{
  dialogScreen.Transparency = 0;
  Wait(1);
  dialogScreen.Visible = true;
  int d = 0;
  while (d<100) 
    { 
      dialogScreen.Transparency = d;
      Wait(1);
      d++;
    } 
  dialogScreen.Visible = false;
  Wait(1);
  Displayc(titleText);   
  Wait(20);
  gCernePozadi.Visible = false;  
  gStatusline.Visible = true;
  gIconbar.Visible = true;
}

// main global script file

// A function that initializes a bunch of stuff.
function initialize_control_panel() { 
  // Centre the control panel
  gPanel.Centre(); 
  // Centre the Restart dialog as well
  gRestartYN.Centre(); 
  if (!IsSpeechVoxAvailable()) { 
    // If there is no speech-vox file, and therefore no speech,
    // disable all the controls related with speech.
    lblVoice.Visible = false;  
    btnVoice.Visible = false;  
    sldVoice.Visible = false;
  }
  else {
    // If there *is*, then set it to voice and text. It's best to use
    // both whenever possible, for the player's sake.
    //SetVoiceMode(eSpeechVoiceAndText); 
    // And reflect this in the control panel.
    btnVoice.Text = "Voice and Text"; 
  }
  if (!System.SupportsGammaControl) {
    // If we can't change the gamma settings, disable the relevant options.
    sldGamma.Visible = false; 
    lblGamma.Visible = false;
  } 
  
  //And now, set all the defaults
  SetMusicMasterVolume(100);
  sldMusic.Value = 200;
  sldSound.Value = 200;
  SetSoundVolume(200);
  SetGameSpeed(50); //40
  sldSpeed.Value = 50;
  if (IsSpeechVoxAvailable()) {
     //SetVoiceMode(eSpeechVoiceAndText);
     btnVoice.Text = "Voice and Text";
     sldVoice.Value = 255;
     SetSpeechVolume(255);
  }
  if (System.SupportsGammaControl) {
    System.Gamma = 100;
    sldGamma.Value = 100;
  }
  
  // ceske nadpisy
  btnRestoreGameMenu.Text = tr("Pokraèovat");
  btnAbout.Text = tr("O HØE");
  btnCancelRestore.Text = tr("Zpìt");
  btnCancelSave.Text = tr("Zpìt");
  btnDefault.Text = tr("VÝCHOZÍ");
  btnRestartNo.Text = tr("Ježiš né!");
  btnRestartYes.Text = tr("ANO pøeji");
  btnSaveGame.Text = tr("Uložit");
  btnRestoreGame.Text = tr("Nahrát");
  btnSave.Text = tr("ULOŽIT");
  btnLoad.Text = tr("NAHRÁT");
  btnResume.Text = tr("POKRAÈOVAT");
  btnQuitYes.Text  = tr("Rychle pryè");
  btnQuitNo.Text  = tr("Tak né, no");
  btnNewGame.Text  = tr("Nová hra");
  lbGameCaption.Text  = tr("Draèí Zub");
  
  lbRestartText.Text = tr("Skuteènì si pøejete restartovat hru?");
  lbLoadGameText.Text  = tr("Pod jakým názvem bude Vaše draèi dobrodružství uchováno?");
  lbRestoreGameText.Text  = tr("Jaké dobrodružství chcete oživit?");
  lbQuitGameText.Text = tr("Skuteène si pøejete opustit hru?");
  
 
  SetGlobalInt(0, day_time*hour_time);
}

function init_iconbar() {
  
  if (isHandheld) {
    
    gStatusline.Height = 18;
    lbGameCaption.Y = 5;
    lbScore.Y = 5;
    if (gIconbar.Visible) {
      gIconbar.SetPosition(0, -4);
      gIconbar.Height = 22;
    }
    // RESTORE DIALOG v HLAVNIM MENU
    btnCurWalk.NormalGraphic = 185;
    btnCurLook.NormalGraphic = 186;
    btnCurUse.NormalGraphic = 187;
    btnCurTalk.NormalGraphic = 188;
    btnIconInv.NormalGraphic = 189;
    btnIconSave.NormalGraphic = 190;
    btnIconLoad.NormalGraphic = 191;
    btnIconAbout.NormalGraphic = 192;
    btnIconExit.NormalGraphic = 193;
    btnIconCurInv.NormalGraphic = 194;
  } else {
    gStatusline.Height = 12;
    lbGameCaption.Y = 1;
    lbScore.Y = 1;
  }
}

// Called when the game starts, before the first room is loaded
function game_start() {   
  Game.Name = "Draèí Zub";

  //SetRestartPoint();  
  // Put the code all in a function and then just call the function. 
  // It saves cluttering up places like game_start.
  GameVersion = "0.78";
  if (DEMO) GameVersion = GameVersion.Append(" DEMO");
  lbVersion.Text = String.Format("v%s",GameVersion);

  
  initialize_control_panel(); 
  // Use the KeyboardMovement module to, per default, replicate the standard
  // keyboard movement of most Sierra games. See KeyboardMovement.txt for more info
  KeyboardMovement.SetMode(eKeyboardMovement_Tapping); 

  // init flashlight
  Flashlight.SetFollowCharacter(cEgo, true);
  DynamicSprite* sprite = DynamicSprite.CreateFromExistingSprite(27, true);
  Flashlight.SetGUIMode(gFlashlight, sprite);
  Flashlight.Radius = 0.0;

  gIconbar.Visible = true;


  /*if (System.OperatingSystem == eOSWindows) {
    Display("Running on Windows!");
  }
  else if (System.OperatingSystem == eOSLinux) {
    Display("Running on Linux!");
  }
  else if (System.OperatingSystem == eOSMacOS) {
    Display("Running on MacOS!");
  }
  else if (System.OperatingSystem == eOSDOS) {
    Display("Running on DOS!");
  } else {
    Display("Running on other platform!");
  }
*/
  if (System.Version == "3.21.1115") {
      // windows
      isHandheld = false;
      // pokud nejsme na handheldu a mame translation - odstranit zadavani cestiny a pouzit native textbox
      if (IsTranslationAvailable()>0) {
        directInput = false;
      } else {
        directInput = true;
      }
  } else {
      isHandheld = true;
      directInput = false;
  }

  // new position for iconbar
  init_iconbar();

  /*gMainMenu.Visible = false;
  mouse.UseDefaultGraphic();
  player.ChangeRoom(10, 250, 148);*/

  player.ChangeRoom(402, 250, 148);
}


int hacekState = 0; // 0 = nic, 1 = ¡, 2 = ´
int gInputWaitTimer = 0;
int gInputWaitTimer2 = 0;

function btnInpOK_OnClick(GUIControl *control, MouseButton button)
{
   if (isHandheld || !directInput) {
     jmeno = tbName.Text;
   } else {
      jmeno = lbText.Text.Truncate(lbText.Text.Length-1);
   }
   if (jmeno != "") {
     // presune se do mistnosti "intro"
     gCernePozadi.Visible = false;
     gInput.Visible = false;
     player.ChangeRoom(400);
   } else {
      //TODO: Displayc("Hrdina se musí nìjak jmenovat!");
   }
}

String lastCh;





String TrimCZ(String text)
{
    String newText = "";
    int i = 0;
    
    while (i<text.Length) {
      if (tr(String.Format("%c",text.Chars[i])) == tr("ì")) newText = newText.Append(tr("e")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("š")) newText = newText.Append(tr("s")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("è")) newText = newText.Append(tr("c")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("ø")) newText = newText.Append(tr("r")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("ž")) newText = newText.Append(tr("z")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("ý")) newText = newText.Append(tr("y")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("á")) newText = newText.Append(tr("a")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("í")) newText = newText.Append(tr("i")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("é")) newText = newText.Append(tr("e")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("ú")) newText = newText.Append(tr("u")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("ù")) newText = newText.Append(tr("u")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("ï")) newText = newText.Append(tr("d")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("")) newText = newText.Append(tr("t")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("ò")) newText = newText.Append(tr("n")); else
      
      if (tr(String.Format("%c",text.Chars[i])) == tr("Ì")) newText = newText.Append(tr("E")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("Š")) newText = newText.Append(tr("S")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("È")) newText = newText.Append(tr("C")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("Ø")) newText = newText.Append(tr("R")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("Ž")) newText = newText.Append(tr("Z")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("Ý")) newText = newText.Append(tr("Y")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("Á")) newText = newText.Append(tr("A")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("Í")) newText = newText.Append(tr("I")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("É")) newText = newText.Append(tr("E")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("Ú")) newText = newText.Append(tr("U")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("Ù")) newText = newText.Append(tr("U")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("Ï")) newText = newText.Append(tr("D")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("")) newText = newText.Append(tr("T")); else
      if (tr(String.Format("%c",text.Chars[i])) == tr("Ò")) newText = newText.Append(tr("N")); else
      {
        newText = newText.Append( String.Format("%c",text.Chars[i]) );
      }
      i++;
    }
    
    return newText;
}

String LowerCaseStrTrimCZ(String s)
{
  String s2 = TrimCZ(s);
  return s2.LowerCase();
}

function gInputAppendChar(String ch)
{
  
  
  if (gInputWaitTimer2 > 0) return;
  
  // pokud jeste nevyprsel timer opakovani klavesy a je stisknuta stejna klavesa, tak nereagujeme...
  if (lastCh != null) {
    if ((LowerCaseStrTrimCZ(lastCh) == LowerCaseStrTrimCZ(ch)) && (gInputWaitTimer > 0)) return;
  }
  lastCh = ch;

  
  if ((lbText.Text.Length < 25) || (ch=="")) {
    if (lbText.Text.Length > 0) lbText.Text = lbText.Text.Truncate(lbText.Text.Length-1);
    if (ch=="") {
      if (lbText.Text.Length > 0) lbText.Text = lbText.Text.Truncate(lbText.Text.Length-1);
    } else {
      lbText.Text = lbText.Text.Append(tr(ch));
    }
    lbText.Text = lbText.Text.AppendChar('_');
    gInputWaitTimer = 5;
    gInputWaitTimer2 = 3;
  }
}

function handle_flashlight() {

  if (pochoden && (!IsGamePaused())) {
    if (cEgo.View != CHUZE_POCHODEN) cEgo.ChangeView(CHUZE_POCHODEN);
    
    Flashlight.Enabled = true;
    // pokud mame pochoden, tak neztmavit
    gTintScreen.Visible = false;
    
    // zobrazit ohen
    cOhen.Transparency = 10+Random(20);
    if (cOhen.Room != cEgo.Room) cOhen.ChangeRoom(cEgo.Room);
    if (!cOhen.Animating) cOhen.Animate(0, 3, eRepeat, eNoBlock);
    
    cOhen.ManualScaling = true;
    cOhen.Scaling = cEgo.Scaling;
    cOhen.FollowCharacter(cEgo, FOLLOW_EXACTLY, 0);
    
    if ((loop % 5) == 0) {
      int randomShadow = Random(3);
      //Flashlight.Transparency = 20 + randomShadow * 2;
      int ftransparency = 100-FloatToInt(IntToFloat(TintTransp)*1.5) + randomShadow * 2;
      if (ftransparency<0) ftransparency = 0;
      if (ftransparency>100) ftransparency = 100;
      Flashlight.Transparency = ftransparency; 
      Flashlight.Radius = 49.0 + IntToFloat(randomShadow);
    }
    
    if (cEgo.Loop == 3) {
      cOhen.FollowCharacter(null, FOLLOW_EXACTLY, 0);
      cOhen.x = -100;
    }
    
    cOhen.Loop = cEgo.Loop;  
  } else {
    Flashlight.Enabled = false;
  }
}


function updateIconbarVisibility() {
  // gIconbar
  if (isHandheld) {
    /*if (gPanel.Visible) {
      linestate = 0;
      Display("OFF2");
      return;
    }*/
    
    if (gIconbar.Visible) {
      gIconbar.SetPosition(0, -4);
      gIconbar.Height = 22;
      /*if (linestate == 0) {
        DrawingSurface *surface = Room.GetDrawingSurfaceForBackground();
        surface.DrawingColor = Game.GetColorFromRGB(79, 39, 0);
        surface.DrawLine(0, 18, 319, 18);
        surface.Release();
        linestate = 1;
        Display("ON");
      }*/
    }/* else {
      linestate = 0;
    }*/
  } else {
    if (gIconbar.Visible) {
      if ((mouse.y<13) || ((mouse.y<26) && (gIconbar.Y==0))) {
        // show iconbar
        gIconbar.SetPosition(0, 0);
        //mouse.UseModeGraphic(eModePointer);
      } else {
        // remove iconbar
        gIconbar.SetPosition(0, -26);
        //mouse.UseDefaultGraphic();
      }
    }
  }
}

function repeatedly_execute() {

  if (gInputWaitTimer > 0) gInputWaitTimer--;
  if (gInputWaitTimer2 > 0) gInputWaitTimer2--;
  
  if (IsKeyPressed(43)) {
     if (IsKeyPressed(403)) hacekState = 1; else hacekState = 2;
  }
  
  
  if ((gInput.Visible) && (!(isHandheld  || !directInput))) {
    // pokud je videt input a nejsme na mobilnim zarizeni, nacitame klavesy
    
    // je stisknuto vice klaves nez jedna?
    int keysCnt = 0;
    int i = 0;
    while (i<128) {
      if (IsKeyPressed(i)) keysCnt++;
      i++;
    }
    
    if (keysCnt > 1) {
        gInputWaitTimer = 0;
        gInputWaitTimer2 = 0;
    }
    
    if (keysCnt == 1) {
    
    if (IsKeyPressed(13)) {
      btnInpOK_OnClick(null, eMouseLeft);      
    } else if (IsKeyPressed(8)) {
      // smazeme
      gInputAppendChar("");
      
    } else {
    
    bool shift = IsKeyPressed(403);
    if (hacekState == 1) {
      if (shift) {
        // vlozime velke pismeno s hackem  
        
        if (IsKeyPressed(67)) gInputAppendChar("È");
        if (IsKeyPressed(68)) gInputAppendChar("Ï");
        if (IsKeyPressed(69)) gInputAppendChar("Ì");
        if (IsKeyPressed(78)) gInputAppendChar("Ò");
        if (IsKeyPressed(82)) gInputAppendChar("Ø");
        if (IsKeyPressed(83)) gInputAppendChar("Š");
        if (IsKeyPressed(84)) gInputAppendChar("");
        if (IsKeyPressed(90)) gInputAppendChar("Ž");
        
      } else {
        // vlozime male pismeno s hackem  
        if (IsKeyPressed(67)) gInputAppendChar("è");
        if (IsKeyPressed(68)) gInputAppendChar("ï");
        if (IsKeyPressed(69)) gInputAppendChar("ì");
        if (IsKeyPressed(78)) gInputAppendChar("ò");
        if (IsKeyPressed(82)) gInputAppendChar("ø");
        if (IsKeyPressed(83)) gInputAppendChar("š");
        if (IsKeyPressed(84)) gInputAppendChar("");
        if (IsKeyPressed(90)) gInputAppendChar("ž");
      }
      hacekState = 0;
    } else if (hacekState == 2) {
      if (shift) {
        // vlozime velke pismeno s carkou  
        if (IsKeyPressed(65)) gInputAppendChar("Á");
        if (IsKeyPressed(69)) gInputAppendChar("É");
        if (IsKeyPressed(73)) gInputAppendChar("Í");
        if (IsKeyPressed(79)) gInputAppendChar("Ó");
        if (IsKeyPressed(85)) gInputAppendChar("Ú");
        if (IsKeyPressed(89)) gInputAppendChar("Ý");
      } else {
        // vlozime male pismeno s carkou
        if (IsKeyPressed(65)) gInputAppendChar("á");
        if (IsKeyPressed(69)) gInputAppendChar("é");
        if (IsKeyPressed(73)) gInputAppendChar("í");
        if (IsKeyPressed(79)) gInputAppendChar("ó");
        if (IsKeyPressed(85)) gInputAppendChar("ú");
        if (IsKeyPressed(89)) gInputAppendChar("ý");
      }
      hacekState = 0;
    } else {
      if (shift) {
        // vlozime velke pismeno
        if (IsKeyPressed(65)) gInputAppendChar("A");
        if (IsKeyPressed(66)) gInputAppendChar("B");
        if (IsKeyPressed(67)) gInputAppendChar("C");
        if (IsKeyPressed(68)) gInputAppendChar("D");
        if (IsKeyPressed(69)) gInputAppendChar("E");
        if (IsKeyPressed(70)) gInputAppendChar("F");
        if (IsKeyPressed(71)) gInputAppendChar("G");
        if (IsKeyPressed(72)) gInputAppendChar("H");
        if (IsKeyPressed(73)) gInputAppendChar("I");
        if (IsKeyPressed(74)) gInputAppendChar("J");
        if (IsKeyPressed(75)) gInputAppendChar("K");
        if (IsKeyPressed(76)) gInputAppendChar("L");
        if (IsKeyPressed(77)) gInputAppendChar("M");
        if (IsKeyPressed(78)) gInputAppendChar("N");
        if (IsKeyPressed(79)) gInputAppendChar("O");
        if (IsKeyPressed(80)) gInputAppendChar("P");
        if (IsKeyPressed(81)) gInputAppendChar("Q");
        if (IsKeyPressed(82)) gInputAppendChar("R");
        if (IsKeyPressed(83)) gInputAppendChar("S");
        if (IsKeyPressed(84)) gInputAppendChar("T");
        if (IsKeyPressed(85)) gInputAppendChar("U");
        if (IsKeyPressed(86)) gInputAppendChar("V");
        if (IsKeyPressed(87)) gInputAppendChar("W");
        if (IsKeyPressed(88)) gInputAppendChar("X");
        if (IsKeyPressed(89)) gInputAppendChar("Y");
        if (IsKeyPressed(90)) gInputAppendChar("Z");
        
        //misc keys
        if (IsKeyPressed(49)) gInputAppendChar("1");
        if (IsKeyPressed(50)) gInputAppendChar("2");
        if (IsKeyPressed(51)) gInputAppendChar("3");
        if (IsKeyPressed(52)) gInputAppendChar("4");
        if (IsKeyPressed(53)) gInputAppendChar("5");
        if (IsKeyPressed(54)) gInputAppendChar("6");
        if (IsKeyPressed(55)) gInputAppendChar("7");
        if (IsKeyPressed(56)) gInputAppendChar("8");
        if (IsKeyPressed(57)) gInputAppendChar("9");
        if (IsKeyPressed(48)) gInputAppendChar("0");
      } else {
        // vlozime male pismeno
        if (IsKeyPressed(65)) gInputAppendChar("a");
        if (IsKeyPressed(66)) gInputAppendChar("b");
        if (IsKeyPressed(67)) gInputAppendChar("c");
        if (IsKeyPressed(68)) gInputAppendChar("d");
        if (IsKeyPressed(69)) gInputAppendChar("e");
        if (IsKeyPressed(70)) gInputAppendChar("f");
        if (IsKeyPressed(71)) gInputAppendChar("g");
        if (IsKeyPressed(72)) gInputAppendChar("h");
        if (IsKeyPressed(73)) gInputAppendChar("i");
        if (IsKeyPressed(74)) gInputAppendChar("j");
        if (IsKeyPressed(75)) gInputAppendChar("k");
        if (IsKeyPressed(76)) gInputAppendChar("l");
        if (IsKeyPressed(77)) gInputAppendChar("m");
        if (IsKeyPressed(78)) gInputAppendChar("n");
        if (IsKeyPressed(79)) gInputAppendChar("o");
        if (IsKeyPressed(80)) gInputAppendChar("p");
        if (IsKeyPressed(81)) gInputAppendChar("q");
        if (IsKeyPressed(82)) gInputAppendChar("r");
        if (IsKeyPressed(83)) gInputAppendChar("s");
        if (IsKeyPressed(84)) gInputAppendChar("t");
        if (IsKeyPressed(85)) gInputAppendChar("u");
        if (IsKeyPressed(86)) gInputAppendChar("v");
        if (IsKeyPressed(87)) gInputAppendChar("w");
        if (IsKeyPressed(88)) gInputAppendChar("x");
        if (IsKeyPressed(89)) gInputAppendChar("y");
        if (IsKeyPressed(90)) gInputAppendChar("z");   
        
        // misc keys
        if (IsKeyPressed(45)) gInputAppendChar("-");
        if (IsKeyPressed(32)) gInputAppendChar(" ");
        if (IsKeyPressed(337)) gInputAppendChar("0");
        if (IsKeyPressed(338)) gInputAppendChar("1");
        if (IsKeyPressed(339)) gInputAppendChar("2");
        if (IsKeyPressed(340)) gInputAppendChar("3");
        if (IsKeyPressed(341)) gInputAppendChar("4");
        if (IsKeyPressed(342)) gInputAppendChar("5");
        if (IsKeyPressed(343)) gInputAppendChar("6");
        if (IsKeyPressed(344)) gInputAppendChar("7");
        if (IsKeyPressed(345)) gInputAppendChar("8");
        if (IsKeyPressed(346)) gInputAppendChar("9");
        
        if (IsKeyPressed(50)) gInputAppendChar("ì");
        if (IsKeyPressed(51)) gInputAppendChar("š");
        if (IsKeyPressed(52)) gInputAppendChar("è");
        if (IsKeyPressed(53)) gInputAppendChar("ø");
        if (IsKeyPressed(54)) gInputAppendChar("ž");
        if (IsKeyPressed(55)) gInputAppendChar("ý");
        if (IsKeyPressed(56)) gInputAppendChar("á");
        if (IsKeyPressed(57)) gInputAppendChar("í");
        if (IsKeyPressed(48)) gInputAppendChar("é");
        if (IsKeyPressed(59)) gInputAppendChar("ù");
        if (IsKeyPressed(91)) gInputAppendChar("ú");
        
      } 
      }
    }
    }
    
  }  
  
  lbScore.Text = String.Format("%s %d/%d", tr(String.Format("Skóre")), game.score, game.total_score );
  
  
  // put anything you want to happen every game cycle, even when
  // the game is paused, here
  

  //if (IsGamePaused() == 1) 
  // put anything you want to happen every game cycle, but not
  // when the game is paused, here
  
  
  
  // pokud jsme v 
  if (GetRoomProperty("gui")) {
    // pokud jsme v CREDITS, Hlavnim menu nebo v Intru, tak neubíhá èas
    gTintScreen.Transparency = 100;
    return;
  }
  
  // SMYCKA CASU, pokud neni hra ve stavu "paused"
  if (!IsGamePaused()) {
    if (loop >= minute_time) { // if loop timer has expired
      loop = 0;
      minute++;
      if (minute >= hour_time) { // if minute timer has expired
         minute = 0;
         hour++;
         if (hour >= day_time) { // if hour timer has expired
           hour = 0;
           day++;
         }
      }

   } else loop++; 
  }

int time = (hour*hour_time)+minute;
 
 // pocasi
float cas2 = (24.0 / IntToFloat(GetGlobalInt(0))) * IntToFloat(time);
int cas = FloatToInt(cas2); 

int r= 0;


if ((cas2 >= 18.0) && (cas2 < 18.1)) {r= 1; }
if ((cas2 >= 18.1) && (cas2 < 18.2)) {r= 2; }
if ((cas2 >= 18.2) && (cas2 < 18.3)) {r= 3; }
if ((cas2 >= 18.3) && (cas2 < 18.4)) {r= 4; }
if ((cas2 >= 18.4) && (cas2 < 18.5)) {r= 5; }
if ((cas2 >= 18.5) && (cas2 < 18.6)) {r= 6; }
if ((cas2 >= 18.6) && (cas2 < 18.7)) {r= 7; }
if ((cas2 >= 18.7) && (cas2 < 18.8)) {r= 8; }
if ((cas2 >= 18.8) && (cas2 < 18.9)) {r= 9; }
if ((cas2 >= 18.9) && (cas2 < 19.0)) {r= 10; }
if ((cas2 >= 19.0) && (cas2 < 19.1)) {r= 11; }
if ((cas2 >= 19.1) && (cas2 < 19.2)) {r= 12; }
if ((cas2 >= 19.2) && (cas2 < 19.3)) {r= 13; }
if ((cas2 >= 19.3) && (cas2 < 19.4)) {r= 14; }
if ((cas2 >= 19.4) && (cas2 < 19.5)) {r= 16; }
if ((cas2 >= 19.5) && (cas2 < 19.6)) {r= 18; }
if ((cas2 >= 19.6) && (cas2 < 19.7)) {r= 20; }
if ((cas2 >= 19.7) && (cas2 < 19.8)) {r= 22; }
if ((cas2 >= 19.8) && (cas2 < 19.9)) {r= 24; }
if ((cas2 >= 19.9) && (cas2 < 20.0)) {r= 26; }
if ((cas2 >= 20.0) && (cas2 < 20.1)) {r= 28; }
if ((cas2 >= 20.1) && (cas2 < 20.2)) {r= 30; }
if ((cas2 >= 20.2) && (cas2 < 20.3)) {r= 32; }
if ((cas2 >= 20.3) && (cas2 < 20.4)) {r= 34; }
if ((cas2 >= 20.4) && (cas2 < 20.5)) {r= 36; }
if ((cas2 >= 20.5) && (cas2 < 20.6)) {r= 38; }
if ((cas2 >= 20.6) && (cas2 < 20.7)) {r= 40; }
if ((cas2 >= 20.7) && (cas2 < 20.8)) {r= 42; }
if ((cas2 >= 20.8) && (cas2 < 20.9)) {r= 44; }
if ((cas2 >= 20.9) && (cas2 < 21.0)) {r= 46; }
if ((cas2 >= 21.0) && (cas2 < 21.1)) {r= 48; }

if (cas2 >= 21.1) {r= 50; }

if ((cas2 >= 0.0) && (cas2 < 5.1)) {r= 48; }

if ((cas2 >= 5.0) && (cas2 < 5.1)) {r= 46; }
if ((cas2 >= 5.1) && (cas2 < 5.2)) {r= 44; }
if ((cas2 >= 5.2) && (cas2 < 5.3)) {r= 42; }
if ((cas2 >= 5.3) && (cas2 < 5.4)) {r= 40; }
if ((cas2 >= 5.4) && (cas2 < 5.5)) {r= 38; }
if ((cas2 >= 5.5) && (cas2 < 5.6)) {r= 36; }
if ((cas2 >= 5.6) && (cas2 < 5.7)) {r= 34; }
if ((cas2 >= 5.7) && (cas2 < 5.8)) {r= 32; }
if ((cas2 >= 5.8) && (cas2 < 5.9)) {r= 30; }
if ((cas2 >= 5.9) && (cas2 < 6.0)) {r= 28; }
if ((cas2 >= 6.0) && (cas2 < 6.1)) {r= 26; }
if ((cas2 >= 6.1) && (cas2 < 6.2)) {r= 24; }
if ((cas2 >= 6.2) && (cas2 < 6.3)) {r= 22; }
if ((cas2 >= 6.3) && (cas2 < 6.4)) {r= 20; }
if ((cas2 >= 6.4) && (cas2 < 6.5)) {r= 18; }
if ((cas2 >= 6.5) && (cas2 < 6.6)) {r= 14; }
if ((cas2 >= 6.6) && (cas2 < 6.7)) {r= 10; }
if ((cas2 >= 6.7) && (cas2 < 6.8)) {r= 6; }
if ((cas2 >= 6.8) && (cas2 < 6.9)) {r= 4; }
if ((cas2 >= 6.9) && (cas2 < 7.0)) {r= 2; }
if ((cas2 >= 7.0) && (cas2 < 7.1)) {r= 1; }

if ((cas2 >= 7.1) && (cas2 < 18.0)) {r= 0; }
TintTransp = r;

SetGlobalInt(9, cas);
bool LightingHandled = false;

if (pochoden && IsGamePaused()) {
  gTintScreen.Visible = true;
  gTintScreen.Transparency = 100;
  LightingHandled = true;
}

if (pochoden && !IsGamePaused()) {
  //handle_flashlight();
  LightingHandled = true;
}

if (!LightingHandled) {
  gTintScreen.Visible = true;
  gTintScreen.Transparency = 100-r;
}
// TODO: resit interiery, kde se vnoci sviti

lbGameCaption.Text = String.Format("%s %02d:%02d", tr(String.Format("Draèí Zub Verze %s, Èas:",GameVersion)), FloatToInt(cas2),FloatToInt( (cas2-IntToFloat(FloatToInt(cas2)))*100.0/1.6666666) );

}

function SetPochoden(bool state) {
  pochoden = state;
  Flashlight.Enabled = state;
  if (state) {
     // zapne ohen
     if (cEgo.View != CHUZE_POCHODEN) cEgo.ChangeView(CHUZE_POCHODEN);
     cOhen.FollowCharacter(cEgo, FOLLOW_EXACTLY, 0);
     handle_flashlight();
     aPochoden.Play(eAudioPriorityNormal, eRepeat);
  } else {
    // vypne pochoden
    if (cEgo.View != NORMAL_CHUZE) cEgo.ChangeView(NORMAL_CHUZE);
    cOhen.FollowCharacter(null, FOLLOW_EXACTLY, 0);
    cOhen.x = -100;
    gTintScreen.Visible = true;
    gTintScreen.Transparency = 100-TintTransp;
    aPochoden.Stop();
  }
}

function repeatedly_execute_always() {
  updateIconbarVisibility();
  handle_flashlight();
}



function unhandled_event (int what, int type)
{
  if (player.Room == 1) return;
  /*
  TYPE:
  1   Look at hotspot
  2   Interact with hotspot
  3   Use inventory on hotspot
  4   Talk to hotspot
  */
  if (what == 1) {
     // hotspot
     if (type == 1) Displayc(nicTamNeni());
     if (type == 2) Displayc(nicNejdeVzit());
     if (type == 3) Displayc(nicNejdePouzit());
     if (type == 4) Displayc(nicNemluvi());
  }
  if (what == 2) {
     // object
     if (type == 0) Displayc(nicTamNeni());
     if (type == 1) Displayc(nicNejdeVzit());
     if (type == 3) Displayc(nicNejdePouzit());
     if (type == 2) Displayc(nicNemluvi());
  }
  if (what == 3) {
     // character
     if (type == 0) Displayc("Nevím, kdo to je.");
     if (type == 1) Displayc("Radìji nesahat.");
     if (type == 3) Displayc("Nech si to u sebe.");
     if (type == 2) Displayc("Žádná odpovìï..");
  }
  if (what == 4) {
     // nothing
     if (type == 1) Displayc(nicTamNeni());
     if (type == 2) Displayc(nicNejdeVzit());
     if (type == 3) Displayc(nicNejdePouzit());
     if (type == 4) Displayc(nicNemluvi());
  }  
  if (what == 5) {
     // inventory item
     if (type == 0) Displayc("Po bližším prozkoumání jsi nezjistil nic nového.");
     if (type == 3) Displayc("To asi nebude správná kombinace.");
     if (type == 2) Displayc("Jak s tím chceš probùh mluvit?");
  }    
}

function show_inventory_window () 
{
  gInventory.Visible = true;
  // switch to the Use cursor (to select items with)
  mouse.Mode = eModeInteract;
  // But, override the appearance to look like the arrow
  mouse.UseModeGraphic(eModePointer);
}

function show_save_game_dialog()
{
  gSaveGame.Visible = true;
  // Get the list of save games
  lstSaveGamesList.FillSaveGameList();
  if (lstSaveGamesList.ItemCount > 0)
  {
    // If there is at least one, set the default text
    // to be the first game's name
    txtNewSaveName.Text = lstSaveGamesList.Items[0];
  }
  else
  {
    // No save games yet, default empty text.
    txtNewSaveName.Text = "";
  }
  mouse.UseModeGraphic(eModePointer);
  gIconbar.Visible = false;
}

function show_restore_game_dialog()
{
  gRestoreGame.Visible = true;
  lstRestoreGamesList.FillSaveGameList();
  mouse.UseModeGraphic(eModePointer);
  gIconbar.Visible = false;
}

function close_save_game_dialog()
{
  gSaveGame.Visible = false;
  mouse.UseDefaultGraphic();
  gIconbar.Visible = lastIconBarVis;
}

function close_restore_game_dialog()
{
  gRestoreGame.Visible = false;
  if (!GetRoomProperty("gui")) mouse.UseDefaultGraphic();
  gIconbar.Visible = lastIconBarVis;
}




function HideDialog() {
  gDialogBg.Visible = false;
  gDialog2.Visible = false;
  gRestartYN.Visible = false;
  gQuitGame.Visible = false;
  mouse.UseDefaultGraphic();
}

function GoToMenu()
{
  // IS IT USED???
  aMusic5.Play();
  gIconbar.Visible = false;
  gStatusline.Visible = false;
  gMainMenu.Visible = true;
  gRestartYN.Visible = false;
  gPanel.Visible = false;
  ShowIconBar(true);
  mouse.UseModeGraphic(eModePointer);
  player.ChangeRoom(1);  
}

// Called when a key is pressed. keycode holds the key's ASCII code
function on_key_press(eKeyCode keycode) {
  //hacekState = 0;

  updateIconbarVisibility();

  if (player.Room == 1) return;

  
  // pokud jsme v intru, nereagujeme na nic
  if (gInput.Visible) return; 
  
  /*int i = 0;
  String s = "";
  while (i<=512) {
    if (IsKeyPressed(i)) s = s.Append(String.Format("%d, ",i));
    i++;
  }*/
  
  // The following is called before "if game is paused keycode=0", so
  // it'll happen even when the game is paused.


  if (gDialogBg.Visible) {
    // close universal dialog first...
    HideDialog();
    return;
  }
  if ((keycode == eKeyEscape) && gRestartYN.Visible) {
    //Use ESC to cancel restart.
    gRestartYN.Visible = false; 
    gIconbar.Visible = lastIconBarVis;
    // If the panel's not ON, then the player must have gotten here by tapping F9,
    // therefore his cursor needs restoring. If the panel IS on, then it doesn't,
    // because it's already a pointer. Get used to thinking like this!!
    if (!gPanel.Visible) mouse.UseDefaultGraphic();
    return;
  }
  if ((keycode == eKeyEscape) && gPanel.Visible) {
    // Use ESC to turn the panel off.
    gPanel.Visible = false; 
    gIconbar.Visible = lastIconBarVis;
    mouse.UseDefaultGraphic();
    return;
  }
  if ((keycode == eKeyEscape) && (gSaveGame.Visible))
  {
    // Use ESC to close the save game dialog
    close_save_game_dialog();
    return;
  }
  if ((keycode == eKeyEscape) && (gRestoreGame.Visible))
  {
    // Use ESC to close the restore game dialog
    close_restore_game_dialog();
    return;
  }
  
  /*if (keycode == eKeyReturn) { 
    // ENTER, in this case merely confirms restart
    if (gRestartYN.Visible) GoToMenu();
  }*/

  if (IsGamePaused() || (IsInterfaceEnabled() == 0))
  {
    // If the game is paused with a modal GUI on the
    // screen, or the player interface is disabled in
    // a cut scene, ignore any keypresses.
    return;
  }

  // FUNCTION KEYS AND SYSTEM SHORTCUTS
  if (keycode == eKeyEscape) {
    // ESC
    gPanel.Visible = true; 
    gIconbar.Visible = false;
    mouse.UseModeGraphic(eModePointer);
    
    /*lastCursorMode = mouse.Mode;
    mouse.Mode = eModePointer;*/
  }
  if (keycode == eKeyCtrlQ)  {
    //QuitGame(1);   // Ctrl-Q
      mouse.UseModeGraphic(eModePointer);
      gQuitGame.Visible=true;
  }
  if (keycode == eKeyF6) show_save_game_dialog();   // F6
  if (keycode == eKeyF7) show_restore_game_dialog();  // F7
  if (keycode == eKeyF9) {
    // F9, asks the player to confirm restarting (so much better to always confirm first)
    gRestartYN.Visible = true;  
    gIconbar.Visible = false;
    mouse.UseModeGraphic(eModePointer);
  }
  if (keycode == eKeyF12) SaveScreenShot("scrnshot.bmp");  // F12
  if (keycode == eKeyTab) show_inventory_window();  // Tab, show inventory

  // GAME COMMAND SHORTCUTS
  if (mouse.Mode != 1) {
    if (keycode == 'W') mouse.Mode=eModeWalkto; //Notice this alternate way to indicate keycodes.
    if (keycode == 'L') mouse.Mode=eModeLookat; //Note that all we do here is set modes.
    if (keycode == 'U') mouse.Mode=eModeInteract; //If you want something else to happen, such as GUI buttons highlighting,
    if (keycode == 'T') mouse.Mode=eModeTalkto; //you'll need some more scripting done.
    if (keycode == 'I') mouse.Mode=eModeUseinv; //But this will, as-is, give you some standard keyboard shortcuts your players will very much appreciate.
  }
  
  // For extra cursor modes, such as pick up, feel free to add as you will.
  // Uncomment the line below if you use the "Pick Up" mode.
  //if (keycode == 'P' || keycode == 'G') mouse.Mode=eModePickup; 

  // DEBUG FUNCTIONS
  if (keycode == eKeyCtrlS)  Debug(0,0);  // Ctrl-S, give all inventory
  if (keycode == eKeyCtrlV)  Debug(1,0);  // Ctrl-V, version
  if (keycode == eKeyCtrlA)  Debug(2,0);  // Ctrl-A, show walkable areas
  if (keycode == eKeyCtrlX)  Debug(3,0);  // Ctrl-X, teleport to room
  if (keycode == eKeyCtrlW && game.debug_mode) 
    player.PlaceOnWalkableArea(); //Ctrl-W, move to walkable area 
}

int lastRoom, lastX, lastY;

function on_mouse_click(MouseButton button) {

  // called when a mouse button is clicked. button is either LEFT or RIGHT
  if (IsGamePaused() == 1) {
    // Game is paused, so do nothing (ie. don't allow mouse click)
  }
  else if (button == eMouseLeft) {
    bool DoClick = true;
    if ((pochoden) && (Flashlight.Enabled) && !(mouse.Mode == eModeWalkto)) {
      // stop mouse click processing if we click "outside" of light / walking is passed
      // cEgo size: 70x126
      float scale = IntToFloat(cEgo.Scaling) / 100.0;
      // compute player centered x/y coordinates
      int pcy = FloatToInt( IntToFloat(cEgo.y) - (126.0 * scale / 2.0));
      int pcx = cEgo.x;
      
      float D = Maths.Sqrt(IntToFloat(  ((pcx - mouse.x)*(pcx - mouse.x))  + ((pcy - mouse.y)*(pcy - mouse.y))));
      if (D <= Flashlight.Radius) {
        
      } else {
        Displayc("Je tam tma, nic nevidím!");
        DoClick = false;
      }
      
      //String s = String.Format("mouse: %d %d, player: %d %d, pcy: %d scale: %d",mouse.x, mouse.y,  cEgo.x, cEgo.y, pcy,  cEgo.Scaling);
      //Display(s);
    }
    if (!pochoden && JeNoc() && (mouse.Mode == eModeLookat) && (player.Room != 300)) {
      // je noc a nemame pochoden, koukani nefunguje
      Displayc("Je tu tma, nic nevidím!");
      DoClick = false;      
    }
    
    // pokud sme v titulkach prerusime
    if (player.Room == 300) {
      if (typKonceHry == 0) {
        // presun tam, kde jsme byli
        ShowIconBar(true);
        gStatusline.Visible = true;
        player.ChangeRoom(lastRoom, lastX, lastY);
        mouse.UseDefaultGraphic();
        //mouse.UseModeGraphic(eModeWalkto);
        //mouse.Mode = eModeWalkto; //lastCursorMode;
        DoClick = false;
      }
      if (typKonceHry == 1) {
        // presun do menu
        RestartGame();
        //restarted = false;
        //GoToMenu();
        DoClick = false;
      }
    }
    if (DoClick) ProcessClick(mouse.x, mouse.y, mouse.Mode );
  }
  else if (button == eMouseRight || button == eMouseWheelSouth){
    // right-click our mouse-wheel down, so cycle cursor
    if (player.Room!=300)
    if (!GetRoomProperty("gui")) mouse.SelectNextMode();
  }
  else if (button == eMouseMiddle) { 
    // Middle-button-click, default make character walk to clicked area (a little shortcut)
    // Could have been just "player.Walk(mouse.x,mouse.y)", but it's best to
    // leave our options open - what if you have a special script triggered
    // on "walking" mode?
    ProcessClick(mouse.x, mouse.y, eModeWalkto); 
  }
  else if (button == eMouseWheelNorth) { 
    // Mouse-wheel up, cycle cursors 
    // If mode isn't WALK, set the previous mode (notice usage of numbers instead
    // of eNums, when it suits us)...
    if (mouse.Mode>0) mouse.Mode=mouse.Mode-1; 
    else 
    { 
      // ...but if it is WALK mode...
      if (player.ActiveInventory!=null) 
      {
        //...and the player has a selected inventory item, set mouse mode to UseInv. 
        mouse.Mode=eModeUseinv; 
      }
      else 
      {
        // If they don't, however, just set it to mode TALK (change this line if you add more cursor modes)
        mouse.Mode=eModeTalkto; 
      }
    }
  }
}

function interface_click(int interface, int button) {
  // This function is obsolete, from 2.62 and earlier versions.
}

function btnInvUp_Click(GUIControl *control, MouseButton button) {
  invCustomInv.ScrollUp();
}

function btnInvDown_Click(GUIControl *control, MouseButton button) {
  invCustomInv.ScrollDown();
}

function btnInvOK_Click(GUIControl *control, MouseButton button) {
	// They pressed the OK button, close the GUI
	gInventory.Visible = false;
	mouse.UseDefaultGraphic();
}

function btnInvSelect_Click(GUIControl *control, MouseButton button) {
  
	// They pressed SELECT, so switch to the Get cursor
	mouse.Mode = eModeInteract;
	// But, override the appearance to look like the arrow
	mouse.UseModeGraphic(eModePointer);
}

function btnIconInv_Click(GUIControl *control, MouseButton button) {
  HideDialog();
  show_inventory_window();
}

function btnIconCurInv_Click(GUIControl *control, MouseButton button) {
  HideDialog();
  if (player.ActiveInventory != null)
    mouse.Mode = eModeUseinv;
}

function btnIconSave_Click(GUIControl *control, MouseButton button) 
{
  HideDialog();
  updateIconbarVisibility();
  show_save_game_dialog();
}

function btnIconLoad_Click(GUIControl *control, MouseButton button) 
{
  HideDialog();
  updateIconbarVisibility();
  show_restore_game_dialog();
}

function btnIconExit_Click(GUIControl *control, MouseButton button) {
  HideDialog();
  //QuitGame(1);
  mouse.UseModeGraphic(eModePointer);
  gQuitGame.Visible=true;
}

function btnIconAbout_Click(GUIControl *control, MouseButton button) {
  HideDialog();
  gPanel.Visible=true;
  //gIconbar.Visible=lastIconBarVis;
  gIconbar.Visible = false;
  mouse.UseModeGraphic(eModePointer);
}





function cEgo_Look()
{
  if (Random(1) == 1)
    Displayc("Sakryš, dneska mi to sekne!");
  else
    Displayc("To jsem já!");
}

function cEgo_Interact()
{
  if (Random(1) == 1)
    Displayc("Co na mì šmatáš, èoveèe?!");
  else
    Displayc("Protáhl sis ruce a zastrèil košili do kalhot. Nojo, jsi fešák!");
}



function cEgo_Talk()
{
  if (Random(1) == 1)  
    Displayc("Mumly mumly... samomluva z pøepracování?");
  else
    Displayc("Momentálnì nemáš náladu si sám se sebou povídat, snad pøíštì.");
}

//START OF CONTROL PANEL FUNCTIONS
function btnSave_OnClick(GUIControl *control, MouseButton button)
{
  gPanel.Visible = false;
  mouse.UseDefaultGraphic();
  gIconbar.Visible = lastIconBarVis;
  Wait(1);
  btnIconSave_Click(btnIconSave, eMouseLeft);
}

function gControl_OnClick(GUI *theGui, MouseButton button)
{

}

function ShowCredits(int type) {
  typKonceHry = type;
  if (player.Room != 300) {
    ShowIconBar(false);
    lastRoom = player.Room;
    lastX = player.x;
    lastY = player.y;
    mouse.UseModeGraphic(eModePointer);
    player.ChangeRoom(300);
    mouse.UseModeGraphic(eModePointer);
  }
}

function btnAbout_OnClick(GUIControl *control, MouseButton button)
{
  //Displayc("Draèí Zub  1997 - 2009 DjCzermino");
  gPanel.Visible = false;
  ShowCredits(0);
}

function btnQuit_OnClick(GUIControl *control, MouseButton button)
{
  gPanel.Visible = false;
  Wait(1);
  
  //QuitGame(1);
  gQuitGame.Visible=true;
  
  gPanel.Visible = true;
  gIconbar.Visible = false;
  mouse.UseModeGraphic(eModePointer);
}

function btnLoad_OnClick(GUIControl *control, MouseButton button)
{
  gPanel.Visible = false;
  mouse.UseDefaultGraphic();
  gIconbar.Visible = lastIconBarVis;
  Wait(1);
  btnIconLoad_Click(btnIconLoad, eMouseLeft);
}

function btnResume_OnClick(GUIControl *control, MouseButton button)
{
  updateIconbarVisibility();
  gPanel.Visible = false;
  gIconbar.Visible = lastIconBarVis;  
  mouse.UseDefaultGraphic();
}

function sldMusic_OnChange(GUIControl *control)
{
  //SetMusicMasterVolume(sldMusic.Value);  
  Game.SetAudioTypeVolume(eAudioTypeMusic, sldMusic.Value, eVolExistingAndFuture);
}

function sldSound_OnChange(GUIControl *control)
{
  // This sets the sound volume. Note it'll also affect MOD and XM music - read the manual
  SetSoundVolume(sldSound.Value); 
}

function sldVoice_OnChange(GUIControl *control)
{
  // Sets voice volume. Note that we don't check for the existence of speech.vox - 
  // we did that in game_start, so if it's not there the slider won't even be available.
  SetSpeechVolume(sldVoice.Value); 
}

function btnVoice_OnClick(GUIControl *control, MouseButton button)
{
  // Note that we don't check for the existence of speech.vox - we did that in game_start,
  // so if it's not there the button won't even be available.
  if (btnVoice.Text == "Voice and Text") { 
    //SetVoiceMode(eSpeechVoiceOnly); 
    btnVoice.Text = "Voice only";
  }
  else if (btnVoice.Text == "Voice only") {
    //SetVoiceMode(eSpeechTextOnly);
    btnVoice.Text = "Text only";
  }
  else if (btnVoice.Text == "Text only") {
    //SetVoiceMode(eSpeechVoiceAndText);
    btnVoice.Text = "Voice and Text";
  }
}

function sldGamma_OnChange(GUIControl *control)
{
  // Set the gamma. Note there's no need to check for anything else, as we ensured,
  // in game_start, that the slider won't even appear if it's not possible to do this.
  System.Gamma = sldGamma.Value; 
}

function btnDefault_OnClick(GUIControl *control, MouseButton button)
{
  // Reset everything to default. You'll have to edit these as well as the sliders
  // if you'd rather have different default parameters.
  SetMusicMasterVolume(100);
  sldMusic.Value = 200;
  sldSound.Value = 200;
  SetSoundVolume(200);
  sldSpeed.Value = 40;
  SetGameSpeed(40);
  if (IsSpeechVoxAvailable()) {
     //SetVoiceMode(eSpeechVoiceAndText);
     btnVoice.Text = "Voice and Text";
     sldVoice.Value = 255;
     SetSpeechVolume(255);
  }
  if (System.SupportsGammaControl) {
    System.Gamma = 100;
    sldGamma.Value = 100;
  }
}
//END OF CONTROL PANEL FUNCTIONS

function dialog_request(int param) 
{
  // This is used by the dialog text parser if you need to process
  // text that the player types in to the parser.
  // It is not used by default.
}

function sldSpeed_OnChange(GUIControl *control)
{
  SetGameSpeed(sldSpeed.Value);
}

function btnRestart_OnClick(GUIControl *control, MouseButton button)
{
  gRestartYN.Visible=true;
  gIconbar.Visible=false;
}

function btnRestartYes_OnClick(GUIControl *control, MouseButton button)
{
  RestartGame();
  //GoToMenu();
}

function btnRestartNo_OnClick(GUIControl *control, MouseButton button)
{
  gRestartYN.Visible = false;
  gIconbar.Visible = lastIconBarVis;
  // If the panel's not ON, then the player must have gotten here by tapping F9,
  // therefore his cursor needs restoring. If the panel IS on, then it doesn't,
  // because it's already a pointer. Get used to thinking like this!!
  if (!gPanel.Visible) mouse.UseDefaultGraphic(); 
}

function btnCancelSave_OnClick(GUIControl *control, MouseButton button)
{
  close_save_game_dialog();
}

function btnSaveGame_OnClick(GUIControl *control, MouseButton button)
{
  int gameSlotToSaveInto = lstSaveGamesList.ItemCount + 1;
  int i = 0;
  while (i < lstSaveGamesList.ItemCount)
  {
    if (lstSaveGamesList.Items[i] == txtNewSaveName.Text)
    {
      gameSlotToSaveInto = lstSaveGamesList.SaveGameSlots[i];
    }
    i++;
  }
  SaveGameSlot(gameSlotToSaveInto, txtNewSaveName.Text);
  close_save_game_dialog();
}

function btnCancelRestore_OnClick(GUIControl *control, MouseButton button)
{
  updateIconbarVisibility();
  close_restore_game_dialog();
  updateIconbarVisibility();
}

function btnRestoreGame_OnClick(GUIControl *control, MouseButton button)
{
  if (lstRestoreGamesList.SelectedIndex >= 0)
  {
    RestoreGameSlot(lstRestoreGamesList.SaveGameSlots[lstRestoreGamesList.SelectedIndex]);
  }
  updateIconbarVisibility();
  close_restore_game_dialog();
  updateIconbarVisibility();
}

function lstSaveGamesList_OnSelectionCh(GUIControl *control)
{
  txtNewSaveName.Text = lstSaveGamesList.Items[lstSaveGamesList.SelectedIndex];
}

function txtNewSaveName_OnActivate(GUIControl *control)
{
  // Pressing return in the text box simulates clicking the Save button
  btnSaveGame_OnClick(control, eMouseLeft);
}

function btnDeleteSave_OnClick(GUIControl *control, MouseButton button)
{
  if (lstSaveGamesList.SelectedIndex >= 0)
  {
    DeleteSaveSlot(lstSaveGamesList.SaveGameSlots[lstSaveGamesList.SelectedIndex]);
    lstSaveGamesList.FillSaveGameList();
  }
}

function Button1_OnClick(GUIControl *control, MouseButton button)
{
  QuitGame(0);
}

function Button2_OnClick(GUIControl *control, MouseButton button)
{
  gQuitGame.Visible = false;
  gIconbar.Visible = lastIconBarVis;
  // If the panel's not ON, then the player must have gotten here by tapping F9,
  // therefore his cursor needs restoring. If the panel IS on, then it doesn't,
  // because it's already a pointer. Get used to thinking like this!!
  if (!gPanel.Visible) mouse.UseDefaultGraphic(); 
}

function Button4_OnClick(GUIControl *control, MouseButton button)
{
  Wait(1);
  mouse.UseModeGraphic(eModePointer);
  btnIconLoad_Click(btnIconLoad, eMouseLeft);
  mouse.UseModeGraphic(eModePointer);
}

function Button5_OnClick(GUIControl *control, MouseButton button)
{
  QuitGame(0);
}



function BeginNewGame()
{
  //SetRestartPoint();
  restarted = true;
  
  gIconbar.Visible = false;
  gStatusline.Visible = false;
  gMainMenu.Visible = false;
  gCernePozadi.Visible = true;
  mouse.UseModeGraphic(eModePointer);  
  mouse.Visible = false;
  Wait(40);  
  Displayc("Aby se mohl náš pøíbìh vyprávìt ještì po tisíciletích, je tøeba znát jméno našeho hrdiny.");

  jmeno = "";

  inpText.Text = tr("Zadej své jméno. Pamatuj, že náš hrdina je MUŽ!");
  //tbText.Text = "";
  lbText.Text = "_";
  if (isHandheld || !directInput) {
     tbName.Y = lbText.Y;
     tbName.Visible = true;
     lbText.Visible = false;
  } else {
    tbName.Visible = false;
    lbText.Visible = true;
  }
  gInput.Centre();
  gInput.Visible = true;
  
  mouse.UseModeGraphic(eModePointer);  
  mouse.Visible = true;  
}



function Button3_OnClick(GUIControl *control, MouseButton button)
{
  StopMusic();
  gIconbar.Visible = lastIconBarVis;
  gStatusline.Visible = true;
  // UseModeGraphic( eModeWalkto );
  gMainMenu.Visible = false;
  mouse.UseDefaultGraphic();
  
  //player.ChangeRoom(2,160, 160);
  //player.ChangeRoom(4);
  //player.ChangeRoom(300);
  //player.ChangeRoom(16);
  //player.ChangeRoom(400);
  
  /*questCertFaze = 3;
  zobrazCerta = 1;
  player.AddInventory(iKoste);
  player.ChangeRoom(13);*/
  
  
  
  //RestartGame();
  if (restarted == false) BeginNewGame();
  else RestartGame();
}

function dialog_options_get_dimensions(DialogOptionsRenderingInfo *info)
{
  // SPOCITEJ kolik je moznosti k mluveni
  int i = 1,  pocetPolozek = 0;
  while (i <= info.DialogToRender.OptionCount)
  {
    if (info.DialogToRender.GetOptionState(i) == eOptionOn)
    {
      pocetPolozek++;
    }
    i++;
  }
  //Display("%d",pocetPolozek);
  
  // Create a 200x200 dialog options area at (50,100)
  info.X = 170;
  info.Y = 30;
  info.Width = 121;
  info.Height = 10+(pocetPolozek*10);
  // Put the text parser at the bottom (if enabled)
  info.ParserTextBoxX = 10;
  info.ParserTextBoxY = 160;
  info.ParserTextBoxWidth = 180;
}

function dialog_options_render(DialogOptionsRenderingInfo *info)
{
  // Clear the area yellow
  info.Surface.Clear(14);
  
  // SPOCITEJ kolik je moznosti k mluveni
  int i = 1,  pocetPolozek = 0;
  while (i <= info.DialogToRender.OptionCount)
  {
    if (info.DialogToRender.GetOptionState(i) == eOptionOn)
    {
      pocetPolozek++;
    }
    i++;
  }  
  info.Surface.DrawImage(0, 0, 37, 0, 121, 10+(pocetPolozek*10));
  
  i = 1; int  ypos = 5;
  // Render all the options that are enabled
  while (i <= info.DialogToRender.OptionCount)
  {
    if (info.DialogToRender.GetOptionState(i) == eOptionOn)
    {
      if (info.ActiveOptionID == i) info.Surface.DrawingColor = 15; // 14
      else info.Surface.DrawingColor = 14; //4
      
      /*info.Surface.DrawStringWrapped(5, ypos, info.Width - 10, 
                         eFontNormal, eAlignLeft, tr(info.DialogToRender.GetOptionText(i)));*/
      
      
      
      info.Surface.DrawStringWrapped(5, ypos, info.Width - 10, 
                         eFontNormal, eAlignLeft, tr(info.DialogToRender.GetOptionText(i)));
                         
      ypos += GetTextHeight(info.DialogToRender.GetOptionText(i), eFontNormal, info.Width - 10);
    }
    i++;
  }
}

function dialog_options_get_active(DialogOptionsRenderingInfo *info)
{
  int i = 1,  ypos = 5;
  // Find the option that corresponds to where the player clicked
  while (i <= info.DialogToRender.OptionCount)
  {
    if (info.DialogToRender.GetOptionState(i) == eOptionOn)
    {
      ypos += GetTextHeight(info.DialogToRender.GetOptionText(i), eFontNormal, info.Width - 10);
      if ((mouse.y - info.Y) < ypos)
      {
        info.ActiveOptionID = i;
        return;
      }
    }
    i++;
  }
}

function dialog_options_mouse_click(DialogOptionsRenderingInfo *info, MouseButton button)
{
  // do something here if you want!
  
}

function cDeda_Talk()
{
  if (cDeda.View == DEDA_LEZI) {
    Displayc("Dìda spí! Nech to na pozdìji.");
  } else {

    cEgo.Walk(160, 141, eBlock);
    cEgo.LockViewFrame(NORMAL_CHUZE, 4, 0);
    Wait(30);
    cEgo.UnlockView();
    dDeda01.Start();
  }
}

function cDeda_UseInv()
{
  
  if (cDeda.View == DEDA_LEZI) {
    Displayc("Dìda spí! Nech to na pozdìji.");
  } else {

    if (player.ActiveInventory==iJehla) {
      cEgo.Walk(160, 141, eBlock);
      cEgo.LockViewFrame(NORMAL_CHUZE, 4, 0);
      Wait(30);
      cEgo.UnlockView();
      
      dDedaJehla.Start();
    }  else {
      Displayc("Co by s tím chudák dìda dìlal?");
    }
  }
  
}

function iJehla_Interact()
{
  Displayc("Jehla");
}

function iJehla_Look()
{
  Displayc("Toto je ševcovská jehla. Dìda ji používá ke své práci, takže bys mu ji mìl co nejdøíve navrátit.");
}

function cEgo_UseInv()
{
  if (player.ActiveInventory==iJehla) {
    Displayc("Jau!");
    return;
  }
  if (player.ActiveInventory==iMrkev) {
    Displayc("Ham a už je tam!");
    player.LoseInventory(iMrkev);
    return;
  }
  
  if (player.ActiveInventory==iJablicko) {
    Displayc("Ham a už je tam!");
    player.LoseInventory(iJablicko);
    return;
  }
  if (player.ActiveInventory==iMesec) {
    Displayc("Chceš zkusit zkousnutím, jesli jsou pravé?");
    return;
  }
  if (player.ActiveInventory==iKoste) {
    Displayc("Copak jsi èarodìjnice?");
    return;
  }
  Displayc("Ne, opravdu nevím, co po mnì chceš :-)");
}

function cDeda_Look()
{
  Displayc("Jó, tak tohle je náš dìda. Ehm, teda on není ani tak vlastnì tvùj. Prakticky je to uplnì cizí pán, který tì zachránil. No, nedá se nic dìlat, je to prostì náš dìda.");
}

function cDeda_Interact()
{
  Displayc("Radši na dìdu moc nešmatej, bùhví jak by to chudák pochopil.");
}

function cCert_Look()
{
  if (zobrazCerta==1)
  {
    Displayc("Letající ohnivá koulo-potvora!");
  }
  if (zobrazCerta==2)
  {
    Displayc("Vrchní pekelník ve své plné parádì.");
  }
  
}

int kostePlacloCertaCounter = 0;

function cCert_UseInv()
{
  if (zobrazCerta==1)
  {
    // kdyz pouziju koste....
    if (cEgo.ActiveInventory == iKoste) {
      
      if (kostePlacloCertaCounter == 0) {
        Displayc("To byla pecka!");
      } else if (kostePlacloCertaCounter == 1) {
        Displayc("Teï to koupil!");
      } else if (kostePlacloCertaCounter == 2) {
        Displayc("Potvora jedna, ještì to chce jednu!");
      } else if (kostePlacloCertaCounter == 3) {
        PlaySound(9);
        cCert.ChangeRoom(1, 100, 100);
        StopAmbientSound(1);

        ShakeScreenBackground (4, 10, 80); 

        questCertFaze = 4;
        zobrazCerta = 0;
        Wait(100);
        GiveScore(5);
        Displayc("Dokázal jsi to! Vyprášil jsi èertovi kožich! Sláva!");
      }
      kostePlacloCertaCounter++;    
    } else
    Displayc("Tímhle ji asi nevyženem.");
  }
  
  if (zobrazCerta==2)
  {
    Displayc("Tohle na nìj asi neplatí.");
  }
  
  
}

function cCert_Interact()
{
  if (zobrazCerta==1)
  {
    Displayc("Pokusil ses vyèkat na ten pravý okamžik a chòapul jsi po lítající ohnivé kouli!");
    Displayc("Aaaaaau! Horká![Se spálenou rukou jsi rychle ucuknul. Takle to nepùjde...");
  }
  if (zobrazCerta==2)
  {
    Displayc("Takle s èertem asi nehneš.");
  }
}

function cCert_Talk()
{
  if (player.ActiveInventory==iKoste) {
     Displayc("Vypadá to, že v tuto chvíli nemá èert absolutnì náladu si povídat...");
     return;
  }
     
  if (zobrazCerta==1)
  {
    Displayc("\"Hola hola! Létající potvoro! Pøestaò lítat a postav se mi jako chlap!\" zvolal jsi s notnou dávkou pøedstíraného sebevìdomí v hlase.. Bohužel v kalhotách by to chtìlo toho sebevìdomí víc..");
    cCert.Move(132, 160, eBlock, eAnywhere);
    zobrazCerta = 2;
    Wait(20);
    PlaySound(8);
    cCert.Animate(9, 5, 0, eBlock);
    StopAmbientSound(1);
    PlaySound(9);
    cCert.Loop = 0;
    Wait(20);
    Displayc("Kde se vzal, tu se vzal, náhle se pøed tebou objevil smrdutý èert! Tfuj, to ses lek!");
    Wait(20);
    dCert01.Start();
    return;
  }
  if (zobrazCerta==2)
  {
    dCert01.Start();
    return;
  }
}

function udedy_zamest()
{

if (cDeda.View == DEDA_LEZI) {
    Displayc("S tím úklidem to nemusíš tolik pøehánìt, vždy dìda spí!");
  } else {
    cEgo.Walk(96, 121, eBlock);
    zobrazKoste = false;
    Wait(1);
    object[0].Visible=false;
    Wait(1);    
    cEgo.Move(120, 160, eBlock);
    cEgo.Animate(8, 20, 1, eNoBlock);
    Wait(100);
    
    /*cEgo.Move(83, 180, eBlock);
    cEgo.Animate(8, 20, 1, eNoBlock);
    Wait(100);*/
    
    cEgo.Move(63, 200, eBlock);
    cEgo.Animate(8, 20, 1, eNoBlock);
    Wait(100);
    
    cEgo.Move(100, 200, eBlock);
    cEgo.Animate(8, 20, 1, eNoBlock);
    Wait(100);
    
    cEgo.Move(150, 200, eBlock);
    cEgo.Animate(8, 20, 1, eNoBlock);
    Wait(100);    

    cEgo.Move(200, 200, eBlock);
    cEgo.Animate(8, 20, 1, eNoBlock);
    Wait(100);

    cEgo.Move(120, 160, eBlock);
    //cEgo.Move(120, 160, eBlock);
    cEgo.Loop = 3;
    cEgo.Frame = 0;
    zobrazKoste = true;
    Wait(1);
    object[0].Visible=true;
    Wait(1);        
    cEgo.UnlockView();
    cEgo.StopMoving();
    cEgo.Loop=0;
    if (Game.DoOnceOnly("zameteno udedy")) {
      GiveScore(3);
    }
  }
}


function cChaloupka_Interact()
{
  player.ChangeRoom(23, 105, 166);
}

function cKorenarka_Talk()
{
  dKorenarka1.Start();
}


function cBarman_Talk()
{
  cBarman.Animate(0, 0, eRepeat, eNoBlock);
  dBarman1.Start();
}

function cBarman_DaPivo()
  {
    
  // prijde k pipe
  bool jeNapravoOdPipy = (cBarman.x >= 171);
  
  cBarman.Walk(173, 137, eBlock, eAnywhere);
  //cBarman.Move(173, 137, eBlock, eAnywhere);
  
  // otoci se na ni (at je to lepe videt)
  if (jeNapravoOdPipy)
    cBarman.LockViewFrame(BARMAN1, 6, 0);
  else 
    cBarman.LockViewFrame(BARMAN1, 5, 0);
  Wait(15);
  
  
  // je na stole prazdny pulitr? 
  if (object[1].Visible == true) {
    // uklidime pulitr
    cBarman.LockViewFrame(BARMAN1, 10, 0);
    Wait(10);
    object[1].Visible = false;
    cBarman.Animate(9, 0, eOnce, eBlock, eBackwards);
    Wait(20);
    
  }
  
  
  // natoci pivo
  aToci_pivo.Play();
  cBarman.Animate(8, 0, eOnce, eBlock, eForwards);
  cBarman.Animate(8, 0, eOnce, eBlock, eForwards);
  cBarman.Animate(8, 0, eOnce, eBlock, eForwards);
  cBarman.Animate(9, 0, eOnce, eBlock, eForwards);
  
  // zobrazi pivo
  aPut.Play();
  object[1].Visible = true;
  vypilPivo = false;
  cBarman.LockViewFrame(BARMAN1, 10, 0);
  Wait(10);
  
  // odejde
  cBarman.Walk(251, 137, eBlock, eAnywhere);
  cBarman.LockViewFrame(BARMAN1, 5, 0);
  Wait(15);
  cBarman.LockViewFrame(BARMAN1, 0, 0);
  
  // stoji a cumi
  cBarman.Animate(0, 0, eRepeat, eNoBlock);
  
  
}














function iMesec_Look()
{
  if (penize == 0) Displayc("Mìšec s penìzi, ale je prázdný.");
  else if (penize == 1) Displayc("Mìšec s penìzi, je v nìm poslední zlaák.");
  else if (penize == 2) Displayc("Mìšec s penìzi, jsou v nìm poslední dva zlaáky.");
  else if (penize == 3) Displayc("Mìšec s penìzi, jsou v nìm poslední tøi zlaáky.");
  else if (penize == 4) Displayc("Mìšec s penìzi, jsou v nìm ètyøi zlaáky.");
  else Displayc(String.Format("Mìšec s penìzi. Máš v nìm %d zlatých.",penize));
}

function iKlicPokoj_Look()
{
  Displayc("Klíè od pokoje ve mìstì.");
}

function cBarman_UseInv()
{
  if (player.ActiveInventory==iMesec) {  
    // spusti rozhovor
    cBarman.Animate(0, 0, eRepeat, eNoBlock);
    dBarman1.Start();
  } else if (player.ActiveInventory==iKlicPokoj) {
    player.LoseInventory(iKlicPokoj);
    Displayc("Vrátil jsi klíè barmanovi.");
  }
    else {
    Displayc("Co by s tím dìlal?");
  }
}

function cBarman_Look()
{
  Displayc("Hospodský. Dokud si od nìj nìco nekoupíš, nevypadá zrovna pøátelsky.");
}

function cBarman_Interact()
{
  Displayc("Nešahat!");  
}

function cMlynar_Look()
{
  Displayc("To je pan mlynáø.");  
}

function FadeInObject(Object *o)
{
  o.Transparency = 100;
  o.Visible = true;
  int trans = o.Transparency;
  while (trans > 0) {
    trans--;
    o.Transparency = trans;
    Wait(1);
  }  
}

function FadeOutObject(Object *o)
{
  o.Transparency = 0;
  o.Visible = true;
  int trans = o.Transparency;
  while (trans < 100) {
    trans++;
    o.Transparency = trans;
    Wait(1);
  }  
}





function tbText_OnActivate(GUIControl *control)
{
  btnInpOK_OnClick(control, eMouseLeft);
}

function cVodnik_Talk()
{
  cEgo.Walk(226, 187, eBlock);
  cEgo.LockViewFrame(NORMAL_CHUZE, 4, 0);
  Wait(30);
  cEgo.UnlockView();
  dVodnik1.Start();
}

function tbName_OnActivate(GUIControl *control)
{
  btnInpOK_OnClick(control, eMouseLeft);
}

function iPolinko_Look()
{
  Displayc("Polínko do kamen.");
}

function iJablicko_Look()
{
  Displayc("Krásné èerstvé šavnaté jablíèko.");
}

function iJablicko_UseInv()
{
  
}

function ShowDialog2(int dialogId, String caption, String btn1Caption, String btn2Caption) {
  lastDialogId = dialogId;
  gDialog2.Visible = true;
  lbDialog2.Text = tr(caption);
  btnDialog2b1.Text = tr(btn1Caption);
  btnDialog2b2.Text = tr(btn2Caption);
  lastCursorMode = mouse.Mode;
  //mouse.Mode = eModePointer;
  mouse.UseModeGraphic(eModePointer);
  gDialogBg.Visible = true;
}

function btnDialog2b1_OnClick(GUIControl *control, MouseButton button)
{
  // kliknuto na univerzalni dialog, volba 1
  HideDialog();
  
  if (lastDialogId == 1) {
    aKrb_polinko.Play();
    Displayc("Vložil jsi polínko do kamen. Zanedlouho se oheò rozhoøel a místností se rozlýhá krásné praskání ohnì.");
    player.LoseInventory(iPolinko);
  }

  if (lastDialogId == 2) {
    udedy_zamest();
  }
  
  if (lastDialogId == 3) {
    cEgo.Walk(250, 148, eBlock, eWalkableAreas);
    Displayc("Šup na pec.");
    SetPochoden(false);
    //Displayc(String.Format("%d",cEgo.Scaling));
    cEgo.Loop = 9;
    cEgo.x = 259;
    cEgo.y = 52;
    cEgo.ManualScaling= true;
    cEgo.Scaling = 85;
    Wait(100);
    Displayc("Netrvalo dlouho a po nároèném dnu jsi usnul jak dudek...");
    FadeOut(1);
    Wait(100);
    cDeda.ChangeView(DEDA_SEDI);
    cDeda.x=190;
    cDeda.y=180;
    object[1].Visible = false;
    object[2].Visible = false;
    hour = 8;
    minute = Random(30);
    repeatedly_execute();
    aMusic6.Play();
    FadeIn(1);
    Wait(55);
    Displayc("Tak šup dolù z pece! Už je nový den!");
    cEgo.Loop = 0;
    cEgo.Scaling = 68;
    cEgo.Move(250, 148, eBlock, eAnywhere);  
    cEgo.ManualScaling = false;
    CallRoomScript(0);
  }
  
  // lavicka, sed, 15min
  if (lastDialogId == 4) {
    CallRoomScript(0);
  }
}

function btnDialog2b2_OnClick(GUIControl *control, MouseButton button)
{
  // kliknuto na univerzalni dialog, volba 2
  HideDialog();
  if (lastDialogId == 1) {
    if (!JeNoc()) {
      Displayc("Je tu svìtlo, není dùvod zapalovat polínko. A vùbec, radìji s ohnìm pozor!");
    } else {
      Displayc("Tak dobrá, trochu si tu posvítíme...");
      cEgo.LoseInventory(iPolinko);
      player.AddInventory(iPochoden);
      SetPochoden(true);
      
    }
  }
  if (lastDialogId == 2) {
    if (questCertFaze==3) {
      // vzit koste
      cEgo.Walk(96, 121, eBlock);
      
      zobrazKoste = false;
      Wait(1);
      object[0].Visible=false;
      Wait(1);        
      
      cEgo.AddInventory(iKoste);
      cEgo.ActiveInventory = iKoste;

      if (Game.DoOnceOnly("sebral koste")) {
        GiveScore(2);
      }
    } else {
      Displayc("Opravdu nevím, na co by ti teï bylo koštì...");
    }
  }
  // lavicka, sed, 15min
  if (lastDialogId == 4) {
    CallRoomScript(1);
  }
}

function gDialogBg_OnClick(GUI *theGui, MouseButton button)
{
  HideDialog();
}

function btnCurWalk_OnClick(GUIControl *control, MouseButton button)
{
  HideDialog();
  mouse.Mode = eModeWalkto;
}

function btnCurLook_OnClick(GUIControl *control, MouseButton button)
{
  HideDialog();
  mouse.Mode = eModeLookat;
}

function btnCurUse_OnClick(GUIControl *control, MouseButton button)
{
  HideDialog();
  mouse.Mode = eModeInteract;
}

function btnCurTalk_OnClick(GUIControl *control, MouseButton button)
{
  HideDialog();
  mouse.Mode = eModeTalkto;
}

function iPochoden_Look()
{
  Displayc("Hoøící pochodeò, jde od ní teplo a svìtlo, ale radìji s ní opatrnì!");
}

function EndGame(int type, String msg) {
  if (type == 0) {
      // smrt, deduv baracek
      //player.ChangeRoom(401);
      StopMusic();
      lastCursorMode = mouse.Mode;
      mouse.Mode = eModePointer;
      lbKonecHryText.Text = tr(msg);
      hour = 8;
      aKonecHrySmrt.Play();
      LoadDialogScreen(gKonecHry, "");
      ShowIconBar(false);
  }

  if (type == 1) {
    // vyhra
    StopMusic();
    lastCursorMode = mouse.Mode;
    mouse.Mode = eModePointer;
    hour = 8;
    //aMusic8.Play();
    aKonecHrySmrt.Play();
    LoadDialogScreen(gKonecHryDEMO, "");
    ShowIconBar(false);
    Wait(50);
    Displayc("Poté, co jsi vykonal vše, co bylo tøeba, jsi opustil dìdovu chaloupku...");
    Displayc("Tvé kroky tì zavedly až k rozcestí, odkud vidíš vše, co budeš moci navštívit.");
    Displayc("Zámek, vesnici, høbitov, mlýn, jezero a mnoho dalšího! Bohužel si na to budeš muset ještì chvíli poèkat.");
    Wait(50);
    Displayc("Dìkujeme, že jste si zahráli adventuru Draèí Zub DEMO!");
    Wait(50);
  }
}

function gKonecHry_OnClick(GUIControl *control, MouseButton button)
{
  CloseDialogScreen(gKonecHry, "");
  ShowCredits(1);
}

function iKoste_Look()
{
  Displayc("Koštì na zametání a vymetání... Nezapomìò ho vrátit, až udìláš, co je tøeba..");
}

function iMrkev_Look()
{
  Displayc("Krásná èervená mrkev.");
}

AudioClip *lastBgMusic;

function PlayBgMusic(AudioClip *music)
{
  if (isHandheld) {
    StopMusic();
    music.Play();
    return;
  }
  
  if (!Game.IsAudioPlaying(eAudioTypeMusic)) {
    music.Play();
    lastBgMusic = music;
  }
  
  if (music != lastBgMusic) {
    StopMusic();
    music.Play();
    lastBgMusic = music;
    return;
  } else {
    // do nothing, music is playing...
  }
}

function gKonecHryDEMO_OnCli(GUI *theGui, MouseButton button)
{
  CloseDialogScreen(gKonecHryDEMO, "");
  ShowCredits(1);
}
